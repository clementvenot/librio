<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="fr">
<head>
    <meta charset="UTF-8"/>
    <title>Livres</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2 { margin-bottom: 10px; }
        .book {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
        }
        .actions { display: flex; gap: 8px; }
        form label { display: block; margin-bottom: 8px; } 
        input, button { margin-top: 4px; }
    </style>
</head>
<body>

<header>
    <h1>Livres</h1>
    <span th:if="${userEmail != null}" th:text="${userEmail}"></span>
    <a th:href="@{/account}">Mon compte</a> |
    <a th:href="@{/logout}">Se déconnecter</a>
</header>

<!-- Messages flash -->
<div th:if="${success}" th:text="${success}"></div>
<div th:if="${info}" th:text="${info}"></div>
<div th:if="${error}" th:text="${error}"></div>

<hr/>

<!-- Formulaire de création -->
<section>
    <h2>Créer un livre</h2>
    <form th:action="@{/ui/books}" method="post" th:object="${form}">
        <label>ExternalId <input type="text" th:field="*{externalId}"></label>
        <label>Titre <input type="text" th:field="*{title}"></label>
        <label>Sous-titre <input type="text" th:field="*{subtitle}"></label>
        <label>Auteur <input type="text" th:field="*{author}"></label>
        <label>Éditeur <input type="text" th:field="*{publisher}"></label>
        <label>Date de publication <input type="text" th:field="*{publishedDate}" placeholder="format DD/MM/AAAA"></label>
        <label>Catégories <input type="text" th:field="*{categories}"></label>
        <label>Pages <input type="number" th:field="*{pageCount}"></label>
        <label>Note moyenne <input type="number" th:field="*{averageRating}"></label>
        <label>Image (URL) <input type="url" th:field="*{imageMedium}"></label>
        <button type="submit">Créer</button>
    </form>
</section>

<hr/>

<!-- Formulaire de recherche -->
<section>
    <h2>Recherche</h2>
    <form th:action="@{/ui/books}" method="get">
        <label>Titre <input type="text" name="title" th:value="${searchParams?.title}"></label>
        <label>Auteur <input type="text" name="author" th:value="${searchParams?.author}"></label>
        <label>Éditeur <input type="text" name="publisher" th:value="${searchParams?.publisher}"></label>
        <label>Catégories <input type="text" name="categories" th:value="${searchParams?.categories}"></label>
        <label>Note minimale <input type="number" name="minRating" th:value="${searchParams?.minRating}"></label>
        <button type="submit">Rechercher</button>
        <a th:href="@{/ui/books}">Réinitialiser</a>
    </form>
</section>

<hr/>

<!-- Résultats -->
<section th:if="${results != null}">
    <h2 th:text="'Résultats (' + ${#lists.size(results)} + ')'">Résultats</h2>
    <div th:if="${#lists.isEmpty(results)}">Aucun résultat.</div>
    <div th:if="${!#lists.isEmpty(results)}">
        <article th:each="b : ${results}" class="book">
            <div>
                <strong th:text="${b.title}"></strong> |
                Auteur: <span th:text="${b.author}"></span> |
                Éditeur: <span th:text="${b.publisher}"></span> |
                Catégories: <span th:text="${b.categories}"></span> |
                Note: <span th:text="${b.averageRating}"></span>
                <a th:href="@{|/ui/books/${b.externalId}|}">Détails</a>
            </div>
            <div class="actions">
                <form th:action="@{|/ui/books/${b.externalId}/delete|}" method="post">
                    <button type="submit">Supprimer</button>
                </form>
                <form th:if="${favoriteIds == null or !favoriteIds.contains(b.externalId)}"
                      th:action="@{|/ui/books/${b.externalId}/favorite|}" method="post">
                    <button type="submit">Favori</button>
                </form>
                <form th:if="${favoriteIds != null and favoriteIds.contains(b.externalId)}"
                      th:action="@{|/ui/books/${b.externalId}/unfavorite|}" method="post">
                    <button type="submit">Retirer</button>
                </form>
            </div>
        </article>
    </div>
</section>

<!-- Liste complète -->
<section th:if="${books != null}">
    <h2 th:text="'Tous les livres (' + ${#lists.size(books)} + ')'">Tous les livres</h2>
    <div th:if="${#lists.isEmpty(books)}">Aucun livre.</div>
    <div th:if="${!#lists.isEmpty(books)}">
        <article th:each="b : ${books}" class="book">
            <div>
                <strong th:text="${b.title}"></strong> |
                Auteur: <span th:text="${b.author}"></span> |
                Éditeur: <span th:text="${b.publisher}"></span> |
                Catégories: <span th:text="${b.categories}"></span>
                <a th:href="@{|/ui/books/${b.externalId}|}">Détails</a>
            </div>
            <div class="actions">
                <form th:action="@{|/ui/books/${b.externalId}/delete|}" method="post">
                    <button type="submit">Supprimer</button>
                </form>
                <form th:if="${favoriteIds == null or !favoriteIds.contains(b.externalId)}"
                      th:action="@{|/ui/books/${b.externalId}/favorite|}" method="post">
                    <button type="submit">Favori</button>
                </form>
                <form th:if="${favoriteIds != null and favoriteIds.contains(b.externalId)}"
                      th:action="@{|/ui/books/${b.externalId}/unfavorite|}" method="post">
                    <button type="submit">Retirer</button>
                </form>
            </div>
        </article>
    </div>
</section>

</body>
</html>
